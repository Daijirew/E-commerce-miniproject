name: Deploy Production

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # =========================================================
      # üö® ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤: ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏£‡∏±‡∏ô Automated Test
      # =========================================================
      
      # 1. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .env ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÉ‡∏´‡πâ Docker Compose ‡∏£‡∏±‡∏ô‡∏ï‡∏¥‡∏î (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏Å‡∏ï‡∏¥‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ .env ‡∏Ç‡∏∂‡πâ‡∏ô GitHub)
      - name: Create Dummy .env for Testing
        run: |
          touch .env
          echo "PORT=8080" >> .env
          echo "GIN_MODE=release" >> .env
          # ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ DB URL ‡∏´‡∏£‡∏∑‡∏≠ Secret ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏ó‡∏™‡∏ï‡πå ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

      # 2. ‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô Backend & Frontend ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ö‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á CI (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á)
      - name: Start Services for Testing
        run: docker compose up -d --build

      # 3. ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á Node.js ‡πÅ‡∏•‡∏∞ Playwright
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
      - name: Install dependencies
        run: npm ci # (‡∏´‡∏£‡∏∑‡∏≠ npm install ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      # 4. ‡∏™‡∏±‡πà‡∏á‡∏£‡∏±‡∏ô Playwright Test
      - name: Run Playwright tests
        run: npx playwright test

      # 5. ‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Trace/Video) ‡πÑ‡∏ß‡πâ‡∏î‡∏π‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏™‡∏ï‡πå‡∏û‡∏±‡∏á
      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      # =========================================================
      # ‚úÖ ‡∏ñ‡πâ‡∏≤ Test ‡∏ú‡πà‡∏≤‡∏ô‡∏â‡∏•‡∏∏‡∏¢ ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠ (‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
      # =========================================================

      - name: Check Secret Availability
        run: |
          if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "::error::CRITICAL ERROR: Secret is EMPTY! (‡∏´‡∏≤‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠)"
            exit 1
          else
            echo "SUCCESS: Secret detected"
          fi
        env:
          DOCKER_TOKEN: ${{ secrets.DOCKER_PASSWORD }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ecommerce-backend:latest

      - name: Build Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ecommerce-frontend:latest

      - name: Deploy to OpenLandscape Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.OLS_HOST }}
          username: ${{ secrets.OLS_USERNAME }}
          key: ${{ secrets.OLS_SSH_KEY }}
          script: |
            cd /root/myapp
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f
      - name: Deploy to AWS EC2 Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AWS_HOST }}
          username: ${{ secrets.AWS_USERNAME }}
          key: ${{ secrets.AWS_SSH_KEY }}
          script: |
            # ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô path ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ö‡∏ô AWS ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
            cd /home/ubuntu/E-commerce-miniproject
            docker compose pull
            docker compose up -d --remove-orphans
            docker image prune -f